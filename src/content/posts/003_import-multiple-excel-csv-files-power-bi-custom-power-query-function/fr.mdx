---
title: "Importer Plusieurs Fichiers Excel/CSV dans Power BI avec une Fonction Power Query Personnalis√©e"
description: "D√©couvrez comment importer et combiner facilement des fichiers Excel depuis SharePoint avec une fonction Power Query personnalis√©e, simplifiant radicalement votre processus d'int√©gration de donn√©es."
pubDate: "Jan 16 2025"
tags: ["Power BI", "Power Query", "Excel", "CSV", "SharePoint"]
lang: "fr"
heroImage: "https://github.com/user-attachments/assets/436bbc5e-ca3e-468a-926d-7303aaad42ee"
giscusTitleDiscussionsMapping: "Import Multiple Excel/CSV Files into Power BI with a Custom Power Query Function"
draft: true
---

import Link from "@src/components/Link.astro";
import Note from "@src/components/Note.astro";

### Table des mati√®res

<br />
### Introduction

Importer plusieurs fichiers Excel ou CSV dans Power BI ou Excel peut rapidement devenir un casse-t√™te. Heureusement, Power Query propose des connecteurs comme "Dossier" ou "Dossier SharePoint" pour r√©cup√©rer et fusionner des fichiers stock√©s localement ou sur SharePoint/Teams. Cependant, ces connecteurs ajoutent parfois trop de requ√™tes inutiles, ce qui peut compliquer la gestion des donn√©es

Dans cet article, nous allons voir :

- Comment utiliser le connecteur "Dossier SharePoint" pour importer des fichiers
- Pourquoi cette m√©thode peut devenir polluante
- Une alternative plus propre et optimis√©e gr√¢ce √† une fonction Power Query personnalis√©e

<br />
### Utilisation du connecteur "Dossier SharePoint"

G√©n√©ralement, lorsqu'on souhaite importer plusieurs fichiers CSV ou Excel, on utilise le connecteur "Dossier" (pour les fichiers locaux) ou "Dossier SharePoint" (pour les fichiers stock√©s sur SharePoint/Teams).

Prenons un exemple concret : imaginons que vous ayez plusieurs fichiers de donn√©es financi√®res stock√©s dans un dossier SharePoint, s√©par√©s par pays.

![FinancialSample](https://github.com/user-attachments/assets/9e32d6c7-bc85-4d9c-8059-5ec17625db6c)

<Note>
  Vous pouvez t√©l√©charger les donn√©es d'exemple utilis√©es dans cet article via
  ce{" "} <Link href="https://go.microsoft.com/fwlink/?LinkID=521962" external>lien</Link>. Ce sont des donn√©es fictives que j'ai s√©par√©es par pays pour illustrer notre
  cas d'usage.
</Note>

<br />
##### Processus d'importation traditionnel

1. Dans le menu Ruban, cliquez sur : `Accueil > Nouvelle Source > Plus...`
2. Recherchez "Dossier SharePoint"
3. S√©lectionnez-le et cliquez sur "Se connecter"

![SharepointFolderConnector](https://github.com/user-attachments/assets/421d6756-d781-4b54-8ad1-07bb9f8d9700)

4. Saisissez le lien de votre site SharePoint (ou utilisez un param√®tre Power Query)
5. Cliquez sur OK puis sur "Transformer les donn√©es"
6. Dans la colonne "Folder Path", filtrez pour s√©lectionner le dossier contenant vos fichiers
7. Cliquez sur les doubles fl√®ches de la premi√®re colonne pour combiner tous les fichiers

![FirstExample](https://github.com/user-attachments/assets/02dd0b9e-ca9d-47c2-95f1-7de49781da6f)

**üéØ Probl√®me :** √Ä ce stade, vous remarquerez que Power Query cr√©e de nombreux dossiers, requ√™tes et fonctions. C'est l√† que √ßa devient probl√©matique : √† chaque nouvelle importation similaire, vous vous retrouvez avec une multiplication de ces √©l√©ments qui "polluent" votre √©diteur Power Query.

üí° Solution ? Cr√©er une fonction Power Query personnalis√©e !

### Solution de contournement avec une fonction Power Query personnalis√©e

L'id√©e est d'avoir une seule requ√™te propre et optimis√©e qui importe et combine tous les fichiers, sans pollution inutile. Pour r√©soudre ce probl√®me, j'ai d√©velopp√© une fonction Power Query utilitaire qui permet d'importer et de combiner des fichiers Excel stock√©s sur SharePoint ou Teams de mani√®re plus propre.

##### Code de la fonction Power Query (Excel) :

```powerquery
let
    ImportAndCombineExcelFiles = (
        Source as table, folderPath as list, fileExtension as text, SheetOrTableName as text, filterColumnName as text
    ) =>
        let
            NavigateToFolder = List.Accumulate(
                folderPath, Source, (current, item) => current{[Name = item]}[Content]
            ),
            FilterByExtension = Table.SelectRows(NavigateToFolder, each ([Extension] = "." & fileExtension)),
            AddWorkbookContent = Table.AddColumn(FilterByExtension, "Tables", each Excel.Workbook([Content])),
            KeepFileNameAndTables = Table.SelectColumns(AddWorkbookContent, {"Name", "Tables"}),
            RenameFileNameColumn = Table.RenameColumns(KeepFileNameAndTables, {{"Name", "FileName"}}),
            ExpandTablesColumn = Table.ExpandTableColumn(
                RenameFileNameColumn, "Tables", {"Name", "Data"}, {"Name", "Data"}
            ),
            FilterByTableName = Table.SelectRows(ExpandTablesColumn, each ([Name] = SheetOrTableName)),
            ExpandDataColumn =
                let
                    data = FilterByTableName{0}[Data],
                    columns = Table.ColumnNames(data),
                    expanded = Table.ExpandTableColumn(FilterByTableName, "Data", columns, columns)
                in
                    expanded,
            RemoveNameColumn = Table.RemoveColumns(ExpandDataColumn, {"Name"}),
            PromoteHeaders = Table.PromoteHeaders(RemoveNameColumn, [PromoteAllScalars = true]),
            FilterOutHeaderRows = Table.SelectRows(
                PromoteHeaders, each (Record.Field(_, filterColumnName) <> filterColumnName)
            ),
            firstColumnName = Table.ColumnNames(FilterOutHeaderRows){0},
            RenameFirstColumn = Table.RenameColumns(FilterOutHeaderRows, {{firstColumnName, "FileName"}})
        in
            RenameFirstColumn
in
    ImportAndCombineExcelFiles
```

Explication d√©taill√©e de la fonction

**üìå Signature de la fonction**

```powerquery
ImportAndCombineExcelFiles = (
    Source as table, folderPath as list, fileExtension as text, SheetOrTableName as text, filterColumnName as text
) => ...
```

Cette fonction prend **5 param√®tres** :

1. **`Source` (table)** : La source de donn√©es (g√©n√©ralement un SharePoint ou un dossier Teams).
2. **`folderPath` (list)** : Une liste des sous-dossiers permettant de naviguer jusqu'√† l'emplacement cible.
3. **`fileExtension` (text)** : L'extension des fichiers √† importer (ex. `"xlsx"`).
4. **`SheetOrTableName` (text)** : Le nom de la table cible dans chaque fichier Excel (ex: nom de la feuille/table Excel).
5. **`filterColumnName` (text)** : Le nom de la colonne qui servira √† filtrer les lignes d'en-t√™te en double (une colonne qui est pr√©sente dans tous les fichiers).

---

**üìå Explication des √©tapes**

1Ô∏è‚É£ Naviguer jusqu‚Äôau dossier cible

```powerquery
NavigateToFolder = List.Accumulate(
    folderPath, Source, (current, item) => current{[Name = item]}[Content]
),
```

- On utilise `List.Accumulate` pour **naviguer dans les sous-dossiers** sp√©cifi√©s dans `folderPath`.
- √Ä chaque √©tape, on s√©lectionne le sous-dossier jusqu'√† atteindre l‚Äôemplacement final.

---

2Ô∏è‚É£ Filtrer les fichiers par extension

```powerquery
FilterByExtension = Table.SelectRows(NavigateToFolder, each ([Extension] = "." & fileExtension)),
```

- On filtre les fichiers pour ne garder que ceux ayant l'extension sp√©cifi√©e (ex. `.xlsx`).

---

3Ô∏è‚É£ Extraire les tables de chaque fichier Excel

```powerquery
AddWorkbookContent = Table.AddColumn(FilterByExtension, "Tables", each Excel.Workbook([Content])),
```

- On utilise `Excel.Workbook([Content])` pour extraire toutes les **tables et feuilles de calcul** des fichiers Excel.

---

4Ô∏è‚É£ S√©lectionner uniquement les fichiers et leurs tables

```powerquery
KeepFileNameAndTables = Table.SelectColumns(AddWorkbookContent, {"Name", "Tables"}),
RenameFileNameColumn = Table.RenameColumns(KeepFileNameAndTables, {{"Name", "FileName"}}),
```

- On garde uniquement deux colonnes :
  - `Name` (nom du fichier).
  - `Tables` (le contenu du fichier).
- On renomme `Name` en `FileName` pour √©viter toute confusion.

---

5Ô∏è‚É£ D√©plier la colonne contenant les tables

```powerquery
ExpandTablesColumn = Table.ExpandTableColumn(
    RenameFileNameColumn, "Tables", {"Name", "Data"}, {"Name", "Data"}
),
```

- On **d√©plie** la colonne `Tables` pour extraire les noms des tables et leurs donn√©es (`Data`).

---

6Ô∏è‚É£ Filtrer uniquement la table souhait√©e

```powerquery
FilterByTableName = Table.SelectRows(ExpandTablesColumn, each ([Name] = SheetOrTableName)),
```

- On **garde uniquement** la table dont le nom correspond √† `SheetOrTableName`.

---

7Ô∏è‚É£ D√©plier la colonne `Data` (les donn√©es de la table)

```powerquery
ExpandDataColumn =
    let
        data = FilterByTableName{0}[Data],
        columns = Table.ColumnNames(data),
        expanded = Table.ExpandTableColumn(FilterByTableName, "Data", columns, columns)
    in
        expanded,
```

- On r√©cup√®re la **premi√®re ligne** contenant les donn√©es (`Data`).
- On extrait **les noms des colonnes**.
- On **d√©plie** la table en utilisant les noms des colonnes.

---

8Ô∏è‚É£ Supprimer la colonne du nom de la table

```powerquery
RemoveNameColumn = Table.RemoveColumns(ExpandDataColumn, {"Name"}),
```

- On supprime la colonne `Name` car elle n'est plus n√©cessaire.

---

9Ô∏è‚É£ Promouvoir les en-t√™tes

```powerquery
PromoteHeaders = Table.PromoteHeaders(RemoveNameColumn, [PromoteAllScalars = true]),
```

- On utilise `Table.PromoteHeaders` pour **transformer la premi√®re ligne en en-t√™tes de colonne**.

---

üîü Supprimer les lignes d'en-t√™te en double

```powerquery
FilterOutHeaderRows = Table.SelectRows(
    PromoteHeaders, each (Record.Field(_, filterColumnName) <> filterColumnName)
),
```

- On supprime les **lignes o√π la colonne `filterColumnName` contient son propre nom** (celles-ci correspondent souvent √† des doublons d'en-t√™te provenant des fichiers Excel).

---

1Ô∏è‚É£1Ô∏è‚É£ Renommer la premi√®re colonne en `FileName`

```powerquery
firstColumnName = Table.ColumnNames(FilterOutHeaderRows){0},
RenameFirstColumn = Table.RenameColumns(FilterOutHeaderRows, {{firstColumnName, "FileName"}})
```

- On identifie la **premi√®re colonne** du tableau final.
- On la renomme en `"FileName"` pour garder une trace de l‚Äôorigine des donn√©es.

<br />
<Note variant="important">
  Cette fonction ne fonctionne que pour des fichiers stock√©s sur
  SharePoint/Teams.
</Note>


<br />
##### Ajouter la fonction dans notre exemple pr√©c√©dent

1. Dans le menu ruban, cliquez sur `Accueil > Nouvelle Source > Requ√™te vide`.
2. S√©lectionnez la requ√™te et cliquez sur `Accueil > Nouvelle Source > √âditeur avanc√©`.
3. Remplacez tout le code par le bloc de code ci-dessus.
4. Renommez la fonction comme vous le souhaitez. Personnellement, je nomme les fonctions avec des noms explicites, par exemple : `fxImportAndCombineMultipleExcelFilesFromSharepointOrTeams`

![PowerQueryFunction](https://github.com/user-attachments/assets/21b9f16e-d08c-4336-8623-44f272f97f90)

C‚Äôest fait ! La fonction est pr√™te √† √™tre utilis√©e. üéâ


<br />
### Utilisation de la fonction

Pour utiliser notre nouvelle fonction :

1. Cr√©ez une nouvelle requ√™te vide (Accueil > Nouvelle Source > Requ√™te vide)
2. Ouvrez l'√âditeur avanc√©
3. Copiez-collez le code de la fonction
4. Renommer comme vous le souhaitez. Dans cet exemple, nous l‚Äôappelons ‚ÄúMyData‚Äù

![MyDataQuery](https://github.com/user-attachments/assets/af3e7585-2238-417d-ba95-dd06df45f3d4)

```powerquery
let
    Source = SharePoint.Contents("VOTRE_LIEN_DU_SITE_SHAREPOINT", [ApiVersion = 15]),
    ImportAndCombineExcelFiles = fxImportAndCombineMultipleExcelFilesFromSharepointOrTeams(
        Source, {"Documents partages", "General", "FinancialSample"}, "xlsx", "Sheet1", "Segment"
    )
in
    ImportAndCombineExcelFiles
```

Explication

1Ô∏è‚É£ D√©finition de la source SharePoint :
   ```powerquery
   Source = SharePoint.Contents("VOTRE_LIEN_DU_SITE_SHAREPOINT", [ApiVersion = 15])
   ```
   - **SharePoint.Contents** : Cette fonction permet de r√©cup√©rer le contenu d‚Äôun site SharePoint sp√©cifi√©.
   - **"VOTRE_LIEN_DU_SITE_SHAREPOINT"** : Remplace ce texte par l'URL de ton site SharePoint.
   - **[ApiVersion = 15]** : Sp√©cifie la version 15 de l‚ÄôAPI SharePoint √† utiliser pour l'extraction des donn√©es.

2Ô∏è‚É£ Appel de la fonction `fxImportAndCombineMultipleExcelFilesFromSharepointOrTeams` :
   ```powerquery
   ImportAndCombineExcelFiles = fxImportAndCombineMultipleExcelFilesFromSharepointOrTeams(
       Source, {"Documents partages", "General", "FinancialSample"}, "xlsx", "Sheet1", "Segment"
   )
   ```
   - **Source** : La source d√©finie pr√©c√©demment, qui contient les donn√©es du site SharePoint.
   - **`{"Documents partages", "General", "FinancialSample"}`** : Le chemin du dossier dans SharePoint o√π se trouvent les fichiers Excel √† importer.
   - **"xlsx"** : L‚Äôextension des fichiers √† importer (ici, des fichiers Excel).
   - **"Sheet1"** : Le nom de la feuille de calcul √† extraire de chaque fichier Excel.
   - **"Segment"** : La colonne utilis√©e pour filtrer les lignes dans chaque fichier (dans cet exemple, il s'agit de la premi√®re colonne de nos fichiers Excel).

3Ô∏è‚É£ Retourner le r√©sultat final :
   ```powerquery
   in
       ImportAndCombineExcelFiles
   ```
   - Cette ligne renvoie le r√©sultat combin√© des donn√©es extraites et import√©es de SharePoint dans une seule requ√™te.

Et voil√†, les fichiers sont automatiquement import√©s et combin√©s dans une seule requ√™te. C‚Äôest vraiment propre et efficace, non ? üòé

![SecondExample](https://github.com/user-attachments/assets/569eca1c-f153-4d8b-a051-60c547926ece)

<br />
### Bonus ‚Äì Adaptation pour les fichiers CSV

Si vos fichiers sont des CSV, voici une version modifi√©e de la fonction qui prend en compte un s√©parateur personnalis√©. Je vous invite √† la tester et √† l'adapter selon vos besoins :

```powerquery
let
    ImportAndCombineCSVFiles = (Source, folderPath as list, fileExtension as text, separator as text, filterColumnName as text) =>
        let
            NavigateToFolder = List.Accumulate(
                folderPath, Source, (current, item) => current{[Name = item]}[Content]
            ),
            FilterByExtension = Table.SelectRows(NavigateToFolder, each ([Extension] = "." & fileExtension)),
            AddCSVContent = Table.AddColumn(
                FilterByExtension, "Tables", each Csv.Document([Content], [Delimiter = separator])
            ),
            KeepFileNameAndTables = Table.SelectColumns(AddCSVContent, {"Name", "Tables"}),
            RenameFileNameColumn = Table.RenameColumns(KeepFileNameAndTables, {{"Name", "FileName"}}),
            ExpandTablesColumn =
                let
                    data = RenameFileNameColumn{0}[Tables],
                    columns = Table.ColumnNames(data),
                    expanded = Table.ExpandTableColumn(RenameFileNameColumn, "Tables", columns, columns)
                in
                    expanded,
            PromoteHeaders = Table.PromoteHeaders(ExpandTablesColumn, [PromoteAllScalars = true]),
            FilterOutHeaderRows = Table.SelectRows(
                PromoteHeaders, each (Record.Field(_, filterColumnName) <> filterColumnName)
            ),
            firstColumnName = Table.ColumnNames(FilterOutHeaderRows){0},
            RenameFirstColumn = Table.RenameColumns(FilterOutHeaderRows, {{firstColumnName, "FileName"}})
        in
            RenameFirstColumn
in
    ImportAndCombineCSVFiles
```

üìù Et voil√† ! Vous pouvez maintenant importer et fusionner des fichiers CSV aussi facilement que les fichiers Excel. üöÄ

<br />
### Conclusion

Dans cet article, nous avons explor√© une solution de contournement pour importer et combiner efficacement plusieurs fichiers Excel/CSV stock√©s sur SharePoint ou Teams, en utilisant une fonction Power Query personnalis√©e. Cette approche r√©sout plusieurs probl√®mes courants rencontr√©s lors de l'importation de fichiers multiples :

- R√©duction de la pollution de l'√©diteur Power Query
- Simplification du processus d'importation de fichiers
- Cr√©ation d'une m√©thode unique et r√©utilisable pour l'importation de donn√©es

N'h√©sitez pas √† adapter ces fonctions selon vos besoins et √† partager vos am√©liorations dans les commentaires ! Je serai ravi d'enrichir ma collection de fonctions utilitaires avec vos contributions. üòä
