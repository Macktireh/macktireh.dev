---
title: "Exploiter les API dans Power BI : Authentification, Pagination et plus encore avec Power Query"
description: "A ajouter une description - Exploiter les API dans Power BI"
pubDate: "Jun 09 2025"
tags: ["Power BI", "Power Query", "API", "Authentification", "Pagination"]
lang: "fr"
heroImage: "https://github.com/user-attachments/assets/7df5048d-ffd0-4a30-9cb0-7ff7320a15cd"
giscusTitleDiscussionsMapping: "Flexible Data Source Management in Power BI with MySQL"
---

import Link from "@src/components/Link.astro";
import Note from "@src/components/Note.astro";

### Table des mati√®res

- [Introduction](#introduction)
- [Conclusion](#conclusion)

<br />
### Introduction

L'int√©gration de donn√©es provenant d'une API REST est une √©tape courante dans Power BI, mais elle peut parfois s'av√©rer complexe. L'authentification, les en-t√™tes, la pagination... autant de d√©fis √† surmonter. Dans cet article, je vais vous montrer, √©tape par √©tape, comment importer des donn√©es depuis une API dans Power BI en utilisant Power Query, en g√©rant l'authentification JWT et la pagination. Nous utiliserons l'API <Link href="https://dummyjson.com" external>DummyJSON</Link> comme exemple, une API simple et gratuite, qui r√©pond id√©alement √† nos besoins. Enfin, je pars du principe que vous ma√Ætrisez d√©j√† l‚Äôinterface de Power BI Desktop et l‚Äô√©diteur Power Query, ainsi que les notions essentielles li√©es aux API REST (GET, POST, en-t√™tes, JSON).

### Exploration de l'API DummyJSON

Avant de plonger dans le code Power Query, je vous propose de bien comprendre le fonctionnement de l‚ÄôAPI que nous allons utiliser. Comme mentionn√© dans l‚Äôintroduction, nous allons travailler avec <Link href="https://dummyjson.com" external>DummyJSON</Link>, une ressource id√©ale qui fournit des donn√©es factices au format JSON pour diff√©rents types d‚Äôentit√©s (produits, utilisateurs, articles, etc.). Elle simule √©galement des m√©canismes typiques des API REST, tels que l‚Äôauthentification et la pagination. Pour r√©cup√©rer les donn√©es depuis une API, voici les √©tapes √† suivre :

![Sch√©ma des √©tapes de r√©cup√©ration des donn√©es](https://github.com/user-attachments/assets/2418584b-c52b-46a7-9991-28f431bef14a)

**_Authentification :_**

1. Envoyer une requ√™te (`POST /auth/login`) avec les identifiants : La premi√®re √©tape consiste √† envoyer une requ√™te POST √† l'endpoint d'authentification de l'API (https://dummyjson.com/auth/login). Cette requ√™te doit inclure les identifiants de l'utilisateur (nom d'utilisateur et mot de passe) dans le corps de la requ√™te au format JSON. Par exemple :
   ```json
   {
     "username": "emilys",
     "password": "emilyspass"
   }
   ```
2. Recevoir une r√©ponse contenant les jetons d'acc√®s et de rafra√Æchissement : En r√©ponse √† cette requ√™te, l'API renvoie un objet JSON contenant notamment un `accessToken` et un `refreshToken`. Ces jetons sont essentiels pour acc√©der aux autres endpoints prot√©g√©s par authentification.

<br />

**_R√©cup√©ration des Donn√©es Produits :_**

3. Envoyer une requ√™te (`GET /auth/products`) avec le jeton d'acc√®s (`accessToken`) dans l'en-t√™te : Une fois que vous avez obtenu le jeton d'acc√®s, vous pouvez envoyer une requ√™te `GET` √† l'endpoint des produits (https://dummyjson.com/auth/products). Cette requ√™te doit inclure le jeton d'acc√®s dans l'en-t√™te Authorization sous la forme `Bearer accessToken`.
4. Recevoir les donn√©es produits au format JSON : L'API renvoie alors un objet JSON contenant la liste des produits ainsi que des informations sur la pagination comme `total`, `skip`, et `limit`.
   ```json
     {
       "products": [
         {
           "id": 1,
           "title": "iPhone 13 Pro",
           "description": "Latest iPhone model with advanced features",
           "category": "Electronics",
           "price": 999.99,
           "discountPercentage": 10.5,
           "rating": 4.7,
           "stock": 50,
           "tags": [
             "beauty"
           ],
           "brand": "Apple",
           "sku": "IPHONE13-PRO-256",
           "weight": 0.35,
           "dimensions": {
             "width": 10.5,
             "height": 5.2,
             "depth": 3.8
           },
           "warrantyInformation": "1 year limited warranty",
           "shippingInformation": "Free shipping for orders over $50",
           "availabilityStatus": "In Stock",
           "reviews": [
             {
               "rating": 4,
               "comment": "Great product, highly recommended",
               "date": "2023-05-15",
               "reviewerName": "John Doe",
               "reviewerEmail": "john.doe@example.com"
             }
           ],
           "returnPolicy": "30 days money back guarantee",
           "minimumOrderQuantity": 1,
           "meta": {
             "createdAt": "2023-05-15T10:30:00Z",
             "updatedAt": "2023-05-16T14:20:00Z",
             "barcode": "123456789012",
             "qrCode": "https://example.com/qr/product123"
           },
           "images": [
             "https://example.com/image.jpg"
           ],
           "thumbnail": "https://example.com/thumb.jpg"
         },
         ...
     ],
     "total": 80,
     "skip": 0,
     "limit": 20
   }
   ```

<br />

### Configuration des param√®tres et des fonctions Power Query

Pour interagir proprement avec l'API, nous allons cr√©er plusieurs param√®tres/fonctions Power Query (language M).

#### 1. Configuration des param√®tres globaux Power Query

La premi√®re √©tape consiste √† d√©finir des param√®tres globaux dans Power Query. Cela permet de centraliser les configurations et de les modifier facilement sans toucher au code des fonctions.
Dans l'√âditeur Power Query, sous l'onglet `Accueil`, cliquez sur `G√©rer les param√®tres` > `Nouveau param√®tre` et ajouter les param√®tres ci-dessous :.

- `API_BASE_URL` :
  - `Description` : L'URL de base de l'API DummyJSON.
  - `Type` : Texte
  - `Valeur` : https://dummyjson.com
- `API_LOGIN_USERNAME` :
  - `Description` : Le nom d'utilisateur pour l'authentification.
  - `Type` : Texte
  - `Valeur` : emilys
- `API_LOGIN_PASSWORD` :
  - `Description` : Le mot de passe pour l'authentification.
  - `Type` : Texte
  - `Valeur` : emilyspass
- `API_PAGINATION_SKIP` :
  - `Description` : Param√®tre de pagination par d√©faut pour le nombre d'√©l√©ments √† ignorer.
  - `Type` : Nombre d√©cimal
  - `Valeur` : 0
- `API_PAGINATION_LIMIT` :
  - `Description` : Le nombre d'√©l√©ments √† r√©cup√©rer par page.
  - `Type` : Nombre d√©cimal
  - `Valeur` : 20

![Param√®tres power query](https://github.com/user-attachments/assets/7fb091cc-b821-401d-b621-dc93c0bae3d9)

<br />

#### 2. Fonctions Utilitaires pour les Requ√™tes HTTP

Deuxi√®mes √©tape nous allons cr√©er 4 fonctions utilitaires `GetHeaderParameters`, `GetQueryParameters`, `HttpClientGetRequest` et `HttpClientPostRequest` pour g√©rer les requ√™tes HTTP. Ces fonctions serviront de briques de base pour tous nos appels API. Toujours dans l'√âditeur Power Query, sous l'onglet `Accueil`, cliquez sur `Nouvelle source` > `Requ√™te vide` et ajoutez les fonctions ci-dessous.

##### 2.1 `GetHeaderParameters` : Configurer les En-t√™tes de Base

Cette fonction simple pr√©pare un enregistrement (record) avec les en-t√™tes HTTP communs, comme `Content-Type`. Elle peut accepter des en-t√™tes optionnels pour plus de flexibilit√©.

```powerquery title="GetHeadersParameters"
let
    GetHeadersParameters = (optional Headers as record) =>
        let
            Headers = Record.Combine({[
                #"Content-Type" = "application/json"
            ], (Headers ?? [])})
        in
            Headers
in
    GetHeadersParameters
```

##### 2.2 `GetQueryParameters` : Configurer les Param√®tres de Requ√™te pour la Pagination

Cette fonction aide √† construire l'objet Query pour les appels API, en particulier pour les param√®tres `skip` et `limit`.

```powerquery title="GetQueryParameters"
let
    GetQueryParameters = (optional Skip as number, optional Query as record) =>
        let
            Query = Record.Combine(
                {[
                    skip = Number.ToText(Skip ?? API_PAGINATION_SKIP),
                    limit = Number.ToText(API_PAGINATION_LIMIT)
                ], (Query ?? [])}
            )
        in
            Query
in
    GetQueryParameters
```

##### 2.3 `HttpClientGetRequest` : G√©rer les Requ√™tes HTTP GET

Cette fonction g√©n√©rique envoie une requ√™te GET vers l'API, en prenant en compte le chemin relatif, les param√®tres de requ√™te et les en-t√™tes. Elle utilise la fonction `Web.Contents` de Power Query pour effectuer l'appel HTTP avec l'URL de base `API_BASE_URL` d√©finie pr√©c√©demment et renvoie la r√©ponse en JSON.

```powerquery title="HttpClientGetRequest"
let
    HttpClientGetRequest = (RelativePath as text, optional Query as record, optional Headers as record) =>
        let
            Options = [
                RelativePath = RelativePath,
                Query = (Query ?? []),
                Headers = (Headers ?? [])
            ],
            RawData = Web.Contents(API_BASE_URL, Options),
            Json = Json.Document(RawData)
        in
            Json
in
    HttpClientGetRequest
```

##### 2.4 `HttpClientPostRequest` : G√©rer les Requ√™tes HTTP POST

Similaire √† la fonction pr√©c√©dente, mais pour les requ√™tes POST, qui incluent souvent un corps (`Body`). Lorsqu'un corps de requ√™te est ajout√©, la fonction `Web.Contents` transforme automatiquement la requ√™te en POST comme mentionn√© dans la <Link href="https://learn.microsoft.com/fr-fr/powerquery-m/web-contents" external>documentation</Link>.

```powerquery title="HttpClientPostRequest"
let
    HttpClientPostRequest = (
        RelativePath as text, optional Query as record, optional Headers as record, optional Body as record
    ) =>
        let
            Options = [
                RelativePath = RelativePath,
                Query = (Query ?? []),
                Headers = (Headers ?? []),
                Content = Json.FromValue(Body ?? [])
            ],
            RawData = Web.Contents(API_BASE_URL, Options),
            Json = Json.Document(RawData)
        in
            Json
in
    HttpClientPostRequest
```

<Note>
  Vous avez peut-√™tre remarqu√© que les fonctions `HttpClientGetRequest` et `HttpClientPostRequest` sont similaires. La principale diff√©rence est que `HttpClientPostRequest` re√ßoit un param√®tre `Body` et l'ajoute dans l'option `Content` de la fonction `Web.Contents`. Vous vous demandez peut-√™tre pourquoi ne pas combiner les deux fonctions en une seule. Je comprends et je me suis pos√© la m√™me question et j'ai tent√© de cr√©er une seule fonction HttpClient, comme illustr√© ci-dessous.

  <details>
    <summary>Fonction G√©n√©rique `HttpClient` :</summary>

    ```powerquery title="HttpClient"
    let
        HttpClient = (
            RelativePath as text, optional Query as record, optional Headers as record, optional Body as record
        ) =>
            let
                GetOptions = [
                    RelativePath = RelativePath,
                    Query = (Query ?? []),
                    Headers = (Headers ?? [])
                ],
                PostOptions = [
                    RelativePath = RelativePath,
                    Query = (Query ?? []),
                    Headers = (Headers ?? []),
                    Content = Json.FromValue(Body ?? [])
                ],
                Options = if Body <> null and Record.FieldCount(Body) > 0 then PostOptions else GetOptions,
                RawData = Web.Contents(API_BASE_URL, Options),
                Json = Json.Document(RawData)
            in
                Json
    in
        HttpClient
    ```

    Cette fonction fonctionne correctement et prend en charge les requ√™tes `GET` et `POST`. Cependant, il y a un probl√®me. En effet, si vous consultez la fen√™tre des options "Param√®tres de la source de donn√©es" dans Power BI Desktop, un avertissement indique que certaines sources de donn√©es peuvent ne pas √™tre affich√©es en raison de requ√™tes √©crites manuellement. Cela est d√ª au fait que Power Query consid√®re les options de la fonction `Web.Contents` comme dynamiques, car nous utilisons une condition pour choisir entre `GetOptions` et `PostOptions` en fonction du `Body`. Voici un exemple de l'avertissement que vous pourriez voir :

    ![Data source settings](https://github.com/user-attachments/assets/2636a861-6fc0-4504-bf18-19656618322b)

    Cet avertissement emp√™chera la planification de rafra√Æchissement dans le Power BI Service. Pour contourner ce probl√®me, je n'ai pas d'autre solution que de s√©parer la fonction en deux fonctions distinctes : `HttpClientGetRequest` et `HttpClientPostRequest`.
    N'h√©sitez pas √† me faire part de vos r√©flexions sur cette approche dans les commentaires ci-dessous. Je serais ravi d'en discuter avec vous ! üòä

  </details>
</Note>

<br />

#### 3. Gestion de l'Authentification

Maintenant, construisons les fonctions sp√©cifiques √† l'authentification JWT.

##### 3.1 `GetJwtTokens` : Obtenir les Jetons d'Authentification

Cette fonction envoie une requ√™te `POST` √† l'endpoint d'authentification `/auth/login` de l'API pour obtenir les jetons d'acc√®s `accessToken` et de rafra√Æchissement `refreshToken`. Nous allons utiliser la fonction `HttpClientPostRequest` que nous avons cr√©√©e pr√©c√©demment.

```powerquery title="GetJwtTokens"
let
    GetJwtTokens = () =>
        let
            Headers = GetHeadersParameters(),
            Quey = [],
            Body = [
                username = API_LOGIN_USERNAME,
                password = API_LOGIN_PASSWORD
            ],
            Response = HttpClientPostRequest("auth/login", Quey, Headers, Body),
            JwtTokens = [
                accessToken = Record.Field(Response, "accessToken"),
                refreshToken = Record.Field(Response, "refreshToken")
            ]
        in
            JwtTokens
in
    GetJwtTokens
```

##### 3.2 `GetHeadersParametersWithAccessToken` : Ajouter le Jeton JWT aux En-t√™tes

Cette fonction √©tend `GetHeadersParameters` en int√©grant un jeton JWT aux en-t√™tes HTTP. Elle commence par obtenir le jeton d'acc√®s via `GetJwtTokens`, puis fusionne ce jeton avec les en-t√™tes existants. Ainsi, toutes les requ√™tes HTTP authentifi√©es contiennent le jeton d'acc√®s requis pour l'autorisation.

```powerquery title="GetHeadersParametersWithAccessToken"
let
    GetHeadersParametersWithAccessToken = (optional Headers as record) =>
        let
            JwtToken = GetJwtTokens(),
            accessToken = Record.Field(JwtToken, "accessToken"),
            Headers = Record.Combine(
                {GetHeadersParameters((Headers ?? [])), [
                    Authorization = Text.Format("Bearer #{0}", {accessToken})
                ]}
            )
        in
            Headers
in
    GetHeadersParametersWithAccessToken
```

#### 4. R√©cup√©ration des donn√©es et gestion de la pagination

Maintenant, nous allons cr√©er la fonction principale `FetchDataFromApi`. Cette fonction sera responsable de l'ensemble de la logique n√©cessaire pour obtenir les donn√©es depuis l'API, y compris la gestion de la pagination.

```powerquery title="FetchDataFromApi"
let
    FetchDataFromApi = (RelativePath as text, ResultsFieldName as text, TotalFieldName as text) =>
        let
            // Function to get the total number from the API response
            RetrieveTotalCount = (FieldName as text) =>
            let
                ApiResponse = HttpClientGetRequest(
                    RelativePath, GetQueryParameters(), GetHeadersParametersWithAccessToken()
                ),
                TotalCount = Record.Field(ApiResponse, FieldName)
            in
                TotalCount,

            // Function to get a page based on the index
            FetchPage = (FieldName as text, PageIndex as number) =>
                let
                    Offset = (PageIndex ?? 0) * API_PAGINATION_LIMIT,
                    QueryParams = GetQueryParameters(Offset),
                    AuthHeaders = GetHeadersParametersWithAccessToken(),
                    ApiResponse = HttpClientGetRequest(RelativePath, QueryParams, AuthHeaders),
                    Results = Record.Field(ApiResponse, FieldName)
                in
                    Results,

            // Function to get all by iterating through pages
            GetAllData = () =>
                let
                    TotalProducts = RetrieveTotalCount(TotalFieldName),
                    MaxCount = List.Max({API_PAGINATION_LIMIT, TotalProducts}),
                    TotalPages = Number.RoundUp(MaxCount / API_PAGINATION_LIMIT),
                    PageIndices = {0..TotalPages - 1},
                    AllPages = List.Transform(PageIndices, each FetchPage(ResultsFieldName, _)),
                    CombinedPages = List.Union(AllPages),
                    DataTable = Table.FromList(CombinedPages, Splitter.SplitByNothing(), null, null, ExtraValues.Error),
                    ColumnIndices = List.Positions(Table.ColumnNames(DataTable)),
                    RecordColumnIndex = List.First(
                        List.Select(
                            ColumnIndices, each Type.Is(Value.Type(Record.FieldValues(DataTable{0}){_}), type record)
                        )
                    ),
                    RecordColumnName = Table.ColumnNames(DataTable){RecordColumnIndex},
                    RecordFieldNames = Record.FieldNames(Record.FieldValues(DataTable{0}){RecordColumnIndex}),
                    ExpandedTable = Table.ExpandRecordColumn(
                        DataTable, RecordColumnName, RecordFieldNames, RecordFieldNames
                    )
                in
                    ExpandedTable
        in
            GetAllData()
in
    FetchDataFromApi
```

Je ne vais pas entrer dans les d√©tails de chaque ligne de code, je vous encourage √† examiner le code pour bien comprendre son fonctionnement. Mais voici comment elle fonctionne en r√©sum√© :

1. **_Elle a besoin de savoir o√π chercher_** : Vous lui donnez le chemin sp√©cifique de l'API `RelativePath`, le nom du champ dans la r√©ponse de l'API qui contient la liste des r√©sultats `ResultsFieldName`, et le nom du champ qui indique le nombre total d'√©l√©ments disponibles `TotalFieldName`.
2. **_Compter le total_** : D'abord, elle fait un premier appel √† l'API juste pour savoir combien il y a d'√©l√©ments au total √† r√©cup√©rer. C'est comme regarder le nombre total de pages dans un livre. üî¢
3. **_R√©cup√©rer page par page_** : Ensuite, sachant combien d'√©l√©ments il y a et combien d'√©l√©ments sont affich√©s par page (gr√¢ce au param√®tre `API_PAGINATION_LIMIT`), elle calcule le nombre de pages √† aller chercher. Puis, elle demande √† l'API chaque page, l'une apr√®s l'autre, en utilisant les fonctions d'authentification et de requ√™te que nous avons d√©finies plus t√¥t. üö∂‚Äç‚ôÄÔ∏èüö∂‚Äç‚ôÇÔ∏è
4. **_Tout rassembler_** : Une fois que toutes les pages de donn√©es ont √©t√© r√©cup√©r√©es, elle les combine en une seule grande liste. ‚ûï
5. **_Transformer en tableau propre_** : Finalement, cette liste est transform√©e en un tableau Power Query. Si les donn√©es de chaque page sont des enregistrements (comme des lignes avec plusieurs colonnes d'informations), elle d√©tecte automatiquement cette structure et d√©plie ces enregistrements pour que chaque information ait sa propre colonne. üìä

En gros, `FetchDataFromApi` s'occupe de tout le travail de pagination pour vous donner un tableau unique et complet avec toutes les donn√©es de l'API. ‚ú®

#### 5. Enregistrer les fonctions dans Power Query

Une fois que vous avez cr√©√© toutes les fonctions, assurez-vous de les enregistrer dans Power Query. Vous pouvez le faire sous l'onglet `Accueil`, cliquez sur `Nouvelle source` > `Requ√™te vide dans l'√âditeur Power Query. Puis ouvrez l'√©diteur avanc√© et collez le code de chaque fonction. N'oubliez pas de nommer chaque fonction correctement pour qu'elles soient facilement identifiables.

Par example pour la fonction `GetHeadersParameters` :

![GetHeadersParameters function](https://github.com/user-attachments/assets/986f278f-83b1-41d1-8872-d35f646cbf5f)

Je vous laisse ajouter les autres fonctions de la m√™me mani√®re. Vous pouvez √©galement cr√©er des dossiers dans l'√©diteur Power Query pour organiser vos param√®tres et fonctions. Cela vous aidera √† garder votre projet propre et bien structur√©.

![Project file structure](https://github.com/user-attachments/assets/e444438f-4049-44dc-b3d4-7ba0a02e5cbc)

### Importation des donn√©es dans Power BI (Utilisation de la fonction `FetchDataFromApi`)

Maintenant que nous avons configur√© toutes les fonctions n√©cessaires, il est temps de les utiliser pour importer les donn√©es des produits dans Power BI.
Pour importer les donn√©es des produits, nous allons utiliser la fonction `FetchDataFromApi` que nous avons cr√©√©e pr√©c√©demment. Cr√©ez une nouvelle requ√™te vide dans l'√âditeur Power Query, puis ouvrez l'√©diteur avanc√© et collez le code suivant :

```powerquery title="Products"
let
    Source = FetchDataFromApi("auth/products", "products", "total")
in
    Source
```

![Powerquery code for products query](https://github.com/user-attachments/assets/98112183-8faa-45f5-9195-aefa07a85ba7)

Cette requ√™te appelle la fonction `FetchDataFromApi` avec les param√®tres appropri√©s pour r√©cup√©rer les donn√©es des produits. Le premier param√®tre est le chemin relatif de l'API pour les produits `"auth/products"`, le deuxi√®me est le nom du champ dans la r√©ponse qui contient la liste des produits `"products"`, et le troisi√®me est le nom du champ qui indique le nombre total de produits `"total"`. N'oubliez pas de cliquer sur `Terminer` pour charger les donn√©es dans Power BI.

![Products query](https://github.com/user-attachments/assets/7860a108-f550-472c-b548-6162fb55bb72)

De la m√™me mani√®re, si vous souhaitez importer les donn√©es des utilisateurs, la d√©marche sera quasiment identique.

```powerquery title="Users"
let
    Source = FetchDataFromApi("auth/users", "users", "total")
in
    Source
```

C'est simple n'est ce pas ? üòé

<Note variant='tip'>
  Le sch√©ma ci-dessous montre la vue des d√©pendances de requ√™tes (Query Dependencies) dans Power Query. Il permet de visualiser comment les diff√©rentes fonctions et requ√™tes interagissent entre elles. C‚Äôest un excellent moyen de comprendre la structure de ton projet, de rep√©rer les relations entre les √©l√©ments, et de t'assurer que tout est bien connect√©.

![Query Dependencies](https://github.com/user-attachments/assets/12c9c406-b640-46d5-9268-c4a73518954b)

</Note>
