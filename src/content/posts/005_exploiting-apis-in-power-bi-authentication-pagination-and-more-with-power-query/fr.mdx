---
title: "Exploiter les API dans Power BI : Authentification, Pagination et plus encore avec Power Query"
description: "A ajouter une description - Exploiter les API dans Power BI"
pubDate: "May 22 2025"
tags: ["Power BI", "Power Query", "API", "Authentification", "Pagination"]
lang: "fr"
heroImage: "https://github.com/user-attachments/assets/fc5d50c3-248d-4807-b1c1-8d45baddf6da"
giscusTitleDiscussionsMapping: "Flexible Data Source Management in Power BI with MySQL"
---

import Link from "@src/components/Link.astro";
import Note from "@src/components/Note.astro";

### Table des matières

- [Introduction](#introduction)
- [Conclusion](#conclusion)

<br />
### Introduction

L'intégration de données provenant d'une API REST est une étape courante dans Power BI, mais elle peut parfois s'avérer complexe. L'authentification, les en-têtes, la pagination... autant de défis à surmonter. Dans cet article, je vais vous montrer, étape par étape, comment importer des données depuis une API dans Power BI en utilisant Power Query, en gérant l'authentification JWT et la pagination. Nous utiliserons l'API <Link href="https://dummyjson.com" external>DummyJSON</Link> comme exemple, une API simple et gratuite, qui répond idéalement à nos besoins. Enfin, je pars du principe que vous maîtrisez déjà l’interface de Power BI Desktop et l’éditeur Power Query, ainsi que les notions essentielles liées aux API REST (GET, POST, en-têtes, JSON).

### Exploration de l'API DummyJSON

Avant de plonger dans le code Power Query, je vous propose de bien comprendre le fonctionnement de l’API que nous allons utiliser. Comme mentionné dans l’introduction, nous allons travailler avec <Link href="https://dummyjson.com" external>DummyJSON</Link>, une ressource idéale qui fournit des données factices au format JSON pour différents types d’entités (produits, utilisateurs, articles, etc.). Elle simule également des mécanismes typiques des API REST, tels que l’authentification et la pagination. Pour récupérer les données depuis une API, voici les étapes à suivre :

![Schéma des étapes de récupération des données](https://github.com/user-attachments/assets/2418584b-c52b-46a7-9991-28f431bef14a)

**_Authentification :_**

1. Envoyer une requête (`POST /auth/login`) avec les identifiants : La première étape consiste à envoyer une requête POST à l'endpoint d'authentification de l'API (https://dummyjson.com/auth/login). Cette requête doit inclure les identifiants de l'utilisateur (nom d'utilisateur et mot de passe) dans le corps de la requête au format JSON. Par exemple :
   ```json
   {
     "username": "emilys",
     "password": "emilyspass"
   }
   ```
2. Recevoir une réponse contenant les jetons d'accès et de rafraîchissement : En réponse à cette requête, l'API renvoie un objet JSON contenant notamment un `accessToken` et un `refreshToken`. Ces jetons sont essentiels pour accéder aux autres endpoints protégés par authentification.

<br />

**_Récupération des Données Produits :_**

3. Envoyer une requête (`GET /auth/products`) avec le jeton d'accès (`accessToken`) dans l'en-tête : Une fois que vous avez obtenu le jeton d'accès, vous pouvez envoyer une requête `GET` à l'endpoint des produits (https://dummyjson.com/auth/products). Cette requête doit inclure le jeton d'accès dans l'en-tête Authorization sous la forme `Bearer accessToken`.
4. Recevoir les données produits au format JSON : L'API renvoie alors un objet JSON contenant la liste des produits ainsi que des informations sur la pagination comme `total`, `skip`, et `limit`.
   ```json
     {
       "products": [
         {
           "id": 1,
           "title": "iPhone 13 Pro",
           "description": "Latest iPhone model with advanced features",
           "category": "Electronics",
           "price": 999.99,
           "discountPercentage": 10.5,
           "rating": 4.7,
           "stock": 50,
           "tags": [
             "beauty"
           ],
           "brand": "Apple",
           "sku": "IPHONE13-PRO-256",
           "weight": 0.35,
           "dimensions": {
             "width": 10.5,
             "height": 5.2,
             "depth": 3.8
           },
           "warrantyInformation": "1 year limited warranty",
           "shippingInformation": "Free shipping for orders over $50",
           "availabilityStatus": "In Stock",
           "reviews": [
             {
               "rating": 4,
               "comment": "Great product, highly recommended",
               "date": "2023-05-15",
               "reviewerName": "John Doe",
               "reviewerEmail": "john.doe@example.com"
             }
           ],
           "returnPolicy": "30 days money back guarantee",
           "minimumOrderQuantity": 1,
           "meta": {
             "createdAt": "2023-05-15T10:30:00Z",
             "updatedAt": "2023-05-16T14:20:00Z",
             "barcode": "123456789012",
             "qrCode": "https://example.com/qr/product123"
           },
           "images": [
             "https://example.com/image.jpg"
           ],
           "thumbnail": "https://example.com/thumb.jpg"
         },
         ...
     ],
     "total": 80,
     "skip": 0,
     "limit": 20
   }
   ```

<br />

### Importation des Données dans Power BI/Power Query

Pour interagir proprement avec l'API, nous allons créer plusieurs fonctions Power Query (language M).

#### 1. Configuration des paramètres globaux Power Query

La première étape consiste à définir des paramètres globaux dans Power Query. Cela permet de centraliser les configurations et de les modifier facilement sans toucher au code des fonctions.
Dans l'Éditeur Power Query, sous l'onglet `Accueil`, cliquez sur `Gérer les paramètres` > `Nouveau paramètre` et ajouter les paramètres ci-dessous :.

- `API_BASE_URL` :
  - `Description` : L'URL de base de l'API DummyJSON.
  - `Type` : Texte
  - `Valeur` : https://dummyjson.com
- `API_LOGIN_USERNAME` :
  - `Description` : Le nom d'utilisateur pour l'authentification.
  - `Type` : Texte
  - `Valeur` : emilys
- `API_LOGIN_PASSWORD` :
  - `Description` : Le mot de passe pour l'authentification.
  - `Type` : Texte
  - `Valeur` : emilyspass
- `API_PAGINATION_LIMIT` :
  - `Description` : Le nombre d'éléments à récupérer par page.
  - `Type` : Nombre décimal
  - `Valeur` : 20
- `API_PAGINATION_SKIP` :
  - `Description` : Paramètre de pagination par défaut pour le nombre d'éléments à ignorer.
  - `Type` : Nombre décimal
  - `Valeur` : 0

![Paramètres power query](https://github.com/user-attachments/assets/7fb091cc-b821-401d-b621-dc93c0bae3d9)

<br />

#### 2. Fonctions Utilitaires pour les Requêtes HTTP

Deuxièmes étape nous allons créer 4 fonctions utilitaires `GetHeaderParameters`, `GetQueryParameters`, `HttpClientGetRequest` et `HttpClientPostRequest` pour gérer les requêtes HTTP. Ces fonctions serviront de briques de base pour tous nos appels API. Toujours dans l'Éditeur Power Query, sous l'onglet `Accueil`, cliquez sur `Nouvelle source` > `Requête vide` et ajoutez les fonctions ci-dessous.

##### 2.1 `GetHeaderParameters` : Configurer les En-têtes de Base

Cette fonction simple prépare un enregistrement (record) avec les en-têtes HTTP communs, comme `Content-Type`. Elle peut accepter des en-têtes optionnels pour plus de flexibilité.

```powerquery title="GetHeadersParameters"
let
    GetHeadersParameters = (optional Headers as record) =>
        let
            Headers = Record.Combine({[
                #"Content-Type" = "application/json"
            ], (Headers ?? [])})
        in
            Headers
in
    GetHeadersParameters
```

##### 2.2 `GetQueryParameters` : Configurer les Paramètres de Requête pour la Pagination

Cette fonction aide à construire l'objet Query pour les appels API, en particulier pour les paramètres `skip` et `limit`.

```powerquery title="GetQueryParameters"
let
    GetQueryParameters = (optional Skip as number, optional Query as record) =>
        let
            Query = Record.Combine(
                {[
                    skip = Number.ToText(Skip ?? API_PAGINATION_SKIP),
                    limit = Number.ToText(API_PAGINATION_LIMIT)
                ], (Query ?? [])}
            )
        in
            Query
in
    GetQueryParameters
```

##### 2.3 `HttpClientGetRequest` : Gérer les Requêtes HTTP GET

Cette fonction générique envoie une requête GET vers l'API, en prenant en compte le chemin relatif, les paramètres de requête et les en-têtes. Elle utilise la fonction `Web.Contents` de Power Query pour effectuer l'appel HTTP avec l'URL de base `API_BASE_URL` définie précédemment et renvoie la réponse en JSON.

```powerquery title="HttpClientGetRequest"
let
    HttpClientGetRequest = (RelativePath as text, optional Query as record, optional Headers as record) =>
        let
            Options = [
                RelativePath = RelativePath,
                Query = (Query ?? []),
                Headers = (Headers ?? [])
            ],
            RawData = Web.Contents(API_BASE_URL, Options),
            Json = Json.Document(RawData)
        in
            Json
in
    HttpClientGetRequest
```

##### 2.4 `HttpClientPostRequest` : Gérer les Requêtes HTTP POST

Similaire à la fonction précédente, mais pour les requêtes POST, qui incluent souvent un corps (`Body`). Lorsqu'un corps de requête est ajouté, la fonction `Web.Contents` transforme automatiquement la requête en POST comme mentionné dans la <Link href="https://learn.microsoft.com/fr-fr/powerquery-m/web-contents" external>documentation</Link>.

```powerquery title="HttpClientPostRequest"
let
    HttpClientPostRequest = (
        RelativePath as text, optional Query as record, optional Headers as record, optional Body as record
    ) =>
        let
            Options = [
                RelativePath = RelativePath,
                Query = (Query ?? []),
                Headers = (Headers ?? []),
                Content = Json.FromValue(Body ?? [])
            ],
            RawData = Web.Contents(API_BASE_URL, Options),
            Json = Json.Document(RawData)
        in
            Json
in
    HttpClientPostRequest
```

<Note>
  Vous avez peut-être remarqué que les fonctions `HttpClientGetRequest` et `HttpClientPostRequest` sont similaires. La principale différence est que `HttpClientPostRequest` reçoit un paramètre `Body` et l'ajoute dans l'option `Content` de la fonction `Web.Contents`. Vous vous demandez peut-être pourquoi ne pas combiner les deux fonctions en une seule. Je comprends et je me suis posé la même question et j'ai tenté de créer une seule fonction HttpClient, comme illustré ci-dessous.

  <details>
    <summary>Fonction Générique `HttpClient` :</summary>

    ```powerquery title="HttpClient"
    let
        HttpClient = (
            RelativePath as text, optional Query as record, optional Headers as record, optional Body as record
        ) =>
            let
                GetOptions = [
                    RelativePath = RelativePath,
                    Query = (Query ?? []),
                    Headers = (Headers ?? [])
                ],
                PostOptions = [
                    RelativePath = RelativePath,
                    Query = (Query ?? []),
                    Headers = (Headers ?? []),
                    Content = Json.FromValue(Body ?? [])
                ],
                Options = if Body <> null and Record.FieldCount(Body) > 0 then PostOptions else GetOptions,
                RawData = Web.Contents(API_BASE_URL, Options),
                Json = Json.Document(RawData)
            in
                Json
    in
        HttpClient
    ```
    Cette fonction fonctionne parfaitement et gère les requêtes `GET` et `POST`, mais il y a un souci. En effet, avec cette fonction, si vous regardez la fenêtre des options "Data source settings" dans Power BI Desktop, un avertissement indique que certaines sources de données peuvent ne pas être listées en raison de requêtes écrites manuellement.

    ![Data source settings](https://github.com/user-attachments/assets/2636a861-6fc0-4504-bf18-19656618322b)

    Cet avertissement empêchera la planification de rafraîchissement dans le Power BI Service. Pour contourner ce problème, je n'ai pas d'autre solution que de séparer la fonction HttpClient en deux fonctions distinctes : `HttpClientGetRequest` et `HttpClientPostRequest`.
  </details>
</Note>

